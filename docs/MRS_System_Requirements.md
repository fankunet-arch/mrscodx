# MRS 物料收发管理系统需求说明（Draft v0.4 - Post-Audit Update）

项目代号：MRS（Material Receive & Ship）  
所属平台：ABCABC · DC（Data Collection）  
子系统目标范围：入库 + 出库管理 + 库存调整，当前优先「预计收货 + 极速入库」及「基础出库管理」。

**最近更新日期**: 2025-11-25
**状态**: Phase 1 (Inbound) Completed, Phase 2 (Outbound) Implemented, Phase 3 (Inventory) Implemented.

## 1. 项目概述
MRS 物料收发管理系统用于记录和管理所有物料从进入库存（入库）到离开库存（出库）的关键动作，并支持库存盘点调整。

本项目的核心诉求并非立即实现“全功能 WMS 仓储系统”，而是：
- 先解决“预计收货 + 实际入库”的极速录入问题；
- 在不增加一线人员负担的前提下，顺手积累结构化数据（品名、品类、单位、箱规）；
- 为后续 RMS / POS / BMS 等系统提供干净、可用的物料与流转数据基础；
- 实现基础出库管理（门店领料 / 调拨 / 退货等）及实时库存查询与调整。

## 2. 设计目标与原则
### 2.1 核心目标
**预计收货记录**
- 记录即将到货的物料信息，至少包含：物料名称（自由文本）、品类（可选、尽量结构化）、基本单位（如：瓶、kg、包）。
- 条件允许时，增加整件与单件的数量关系（箱规），如：A 糖浆 10 瓶/箱，B 糖浆 15 瓶/箱。

**实际入库极速录入 (Completed)**
- 到货时，前台录入页面可以基于“预计收货单”快速确认或修改数量；
- 支持“极速录入”模式：纯文本输入，后台归一化。
- 实现“自动归一化”：小数箱数（如 1.5 箱）在保存时自动转换为标准单位整数（如 15 瓶）。

**出库记录 (Completed)**
- 支持记录门店领料、店间调拨、退货、报废等出库动作；
- 同样遵循“自动归一化”逻辑，确保存储数据的一致性。

**库存管理 (Completed)**
- 支持对单个SKU进行库存盘点，自动计算盘盈盘亏并记录调整。
- 提供SKU历史履历，追溯每一次库存变动（入库、出库、调整）。

**减轻后续工作量**
- 引入 **AI 辅助导入**：支持粘贴文本块，系统自动解析 [品名]|[箱规]|[单位]|[品类] 格式。
- 引入 **Self-Healing (自愈)** 机制：数据库表缺失或结构不对时，系统尝试自动修复。

### 2.2 设计原则
- **输入框优先、选择框辅助**：核心信息（物料名称、规格描述等）以文本输入为主，避免强制下拉导致录不进去；选择框只作为“建议/补全”，而不是阻碍录入的限制。
- **允许不完美，但可逐步变好**：允许先以“模糊/自然语言”录入，后续后台运营再做归一化与合并。
- **自动状态流转**：批次状态从 Draft -> Receiving -> Confirmed 自动流转，减少人工操作。
- **防止系统成为“黑箱”**：所有自动推断（如箱规匹配、物料归并）必须保留可追溯记录。

## 3. 系统边界与关联系统
### 3.1 边界
MRS 专注以下内容：
- 入库前：预计收货单（预先录入/导入）。
- 入库时：实际入库单（基于预计单或直接创建）。
- 出库时：领料/调拨/退货记录。
- 库存中：库存盘点与调整、库存历史追溯。
- 支撑数据：物料主数据、单位、箱规规则。

不在本期范围：
- 货位管理 / 仓位优化。
- 路线规划 / 配送调度。
- 会计科目核算（可以通过导出或接口给 BMS / 财务）。

## 4. 功能范围 (已实现状态)

### 4.1 收货入库 (Phase 1 - Completed)
- **快速收货 (Quick Receipt)**: 针对移动端优化的极简界面，支持扫码或直接文本录入。
- **批次管理**: 支持创建、编辑、删除收货批次。
- **自动状态更新**: 当录入第一条记录时，批次状态自动从 `draft` 变为 `receiving`。
- **批量导入**: 支持文本粘贴方式批量导入预计收货清单（Smart Bulk Ingest）。
- **AI 辅助**: 提供 Prompt 模板辅助用户整理导入数据。

### 4.2 出库管理 (Phase 2 - Completed)
- **出库单管理**: 支持新建、编辑、查看出库单。
- **多类型支持**: 领料 (Picking)、调拨 (Transfer)、退货 (Return)、报废 (Scrap)。
- **库存联动**: 录入出库明细时，实时查询并显示当前库存（计算公式：总入库 - 总出库）。
- **确认机制**: 出库单确认后状态锁定，库存正式扣减。

### 4.3 库存与数据管理 (Phase 3 - Completed)
- **Dashboard**: 统一的单页应用 (SPA) 界面，管理批次、SKU、品类、出库单及报表。
- **物料主数据 (SKU)**: 管理品名、单位、箱规（1箱=N单位）。
- **库存盘点**: 支持对单个SKU发起库存调整，记录盘盈盘亏。
- **SKU履历**: 可追溯单个SKU的所有库存变动历史。
- **系统维护**: 自检数据库健康状态，支持一键修复 (Self-Healing)。

## 5. 业务流程说明
### 5.1 入库流程
1.  **创建批次**: 后台或前台创建收货批次 (Status: Draft)。
2.  **录入数据**: 操作员录入收货记录（支持小数箱数）。
    *   *自动动作*: 批次状态变为 Receiving。
3.  **合并确认**: 后台管理员查看“合并确认”页面。
    *   系统根据 SKU 聚合原始记录。
    *   管理员调整最终确认数量（支持修改）。
    *   点击“确认全部”或逐行确认。
    *   *数据落库*: 数据写入 `mrs_batch_confirmed_item`，用于库存计算。

### 5.2 出库流程
1.  **新建出库单**: 后台创建出库单，选择类型和去向 (Status: Draft)。
2.  **添加明细**: 选择 SKU，输入整箱数/散数。
    *   *实时反馈*: 系统显示该 SKU 当前理论库存。
3.  **确认出库**: 点击“确认”按钮。
    *   *动作*: 状态变为 Confirmed。
    *   *库存影响*: 该单据数量计入“总出库量”。

### 5.3 库存调整流程
1.  **发起盘点**: 在SKU列表中，针对特定物料发起“盘点/调整”。
2.  **输入实际库存**: 系统显示当前账面库存，用户输入实际盘点的库存数量。
3.  **确认调整**: 系统自动计算差异（盘盈/盘亏），用户填写调整原因后确认。
4.  **生成调整记录**: 系统生成一条类型为“盘点调整”的库存履历，直接影响库存计算。

## 6. 数据库设计 (As-Built)

### 6.1 核心表结构

#### 6.1.1 收货相关
*   **`mrs_batch`** (收货批次主表)
    *   `batch_id`, `batch_code`, `batch_date`, `location_name`, `batch_status` ('draft', 'receiving', 'confirmed', 'posted'), `remark`.
*   **`mrs_batch_raw_record`** (原始收货记录 - 极速录入用)
    *   `raw_record_id`, `batch_id`, `sku_id`, `input_sku_name` (快照), `qty` (文本/数字), `unit_name`, `operator_name`.
*   **`mrs_batch_confirmed_item`** (确认后的入库明细 - 库存来源)
    *   `confirmed_item_id`, `batch_id`, `sku_id`, `total_standard_qty` (整数), `confirmed_case_qty`, `confirmed_single_qty`.

#### 6.1.2 出库相关
*   **`mrs_outbound_order`** (出库单主表)
    *   `outbound_order_id`, `outbound_code`, `outbound_type` (1:Picking, 2:Transfer...), `outbound_date`, `status` ('draft', 'confirmed'), `location_name`, `remark`.
*   **`mrs_outbound_order_item`** (出库单明细)
    *   `outbound_order_item_id`, `outbound_order_id`, `sku_id`, `sku_name` (快照), `total_standard_qty` (整数 - 归一化后), `outbound_case_qty` (记录值), `outbound_single_qty` (记录值).

#### 6.1.3 基础数据
*   **`mrs_sku`**: `sku_id`, `sku_name`, `category_id`, `standard_unit`, `case_unit_name`, `case_to_standard_qty`.
*   **`mrs_category`**: `category_id`, `category_name`.
*   **`sys_users`**: `user_id`, `user_login`, `user_secret_hash` (Password Hash), `user_status`.

### 6.2 关键逻辑：自动归一化 (Auto-Normalization)
系统在存储“数量”时，遵循以下逻辑以确保库存准确性：
1.  前端允许输入小数箱数（例如 1.5 箱）。
2.  后端根据 SKU 的箱规（例如 1 箱 = 10 个）计算总标准单位数：`1.5 * 10 = 15 个`。
3.  数据库 `total_standard_qty` 字段仅存储整数 `15`。
4.  展示时，根据箱规逆向计算显示为 "1箱 5个" 或 "1.5箱"（视前端逻辑而定，目前后端API支持拆分显示）。

## 7. 部署与架构
### 7.1 目录结构
```
/dc_html/mrs/             # 前端入口
  ├── index.php           # 极速收货入口
  ├── backend.php         # 后台管理入口
  ├── api.php             # 统一 API Gateway
  ├── js/                 # backend.js, receipt.js
  └── css/
/app/mrs/                 # 后端逻辑
  ├── api/                # 具体 API 实现 (backend_*.php)
  ├── lib/                # mrs_lib.php (核心库)
  ├── config_mrs/         # env_mrs.php (DB配置)
  └── docs/migrations/    # 数据库迁移脚本
```

### 7.2 安全与权限
- **API Gateway**: 所有请求通过 `api.php?route=...` 转发，并对路由参数进行严格的白名单字符校验，防止目录遍历。
- **Access Control**: 核心 API 文件头包含 `defined('MRS_ENTRY')` 检查，防止直接访问。后台API (`backend_*`) 会自动校验登录状态。
- **认证**:
    - **密码存储**: 用户密码使用 `password_hash()` 配合 `PASSWORD_DEFAULT` (Bcrypt) 算法进行哈希存储。
    - **登录安全**: 实现了基本的暴力破解防护机制（5分钟内5次尝试）。
- **会话管理 (Session)**:
    - **安全配置**: 会话 Cookie 设置为 `HTTPOnly`, `Secure` (仅HTTPS), `SameSite=Strict`。
    - **会话固定防护**: 使用 `session_regenerate_id()` 为新会话生成ID。
    - **超时机制**: 30分钟无活动，会话自动过期。
- **XSS防护**: 前端在渲染动态数据时，统一使用 `escapeHtml` 函数进行转义。

## 8. 已知限制与未来计划
- **[高风险 Bug] 入库确认功能失效**: 在“合并确认”页面，由于一个前端 JavaScript Bug，导致“确认”和“全部确认”按钮点击后无任何反应，**核心入库流程被阻断**。
- **用户管理**: 当前缺乏用户增删改查 UI，需通过数据库直接管理 `sys_users`。
- **报表**: 统计报表功能目前仅有 UI 入口，后端逻辑待完善。
- **记住我功能**: 登录页的“记住我”功能当前实现不完整，仅设置标记 Cookie，并未实现安全的 token 验证机制。
- **原始收货记录查看**: 合并页面中的“查看明细”功能尚未实现，目前是一个 UI 死胡同。
- **移动端适配**: 极速收货页已适配，但后台管理页主要面向 PC 端。
- **前端代码结构**: `backend.js` 文件庞大，功能耦合度高，不利于长期维护，未来可考虑模块化重构。
