# MRS 物料收发管理系统需求与操作手册 (v1.0 - 2025-11-25)

## 1. 项目概述
MRS (Material Receive & Ship) 物料收发管理系统用于记录和管理所有物料从进入库存（入库）到离开库存（出库）的关键动作，并支持库存盘点调整。

本项目的核心诉求并非立即实现“全功能 WMS 仓储系统”，而是：
- 解决“预计收货 + 实际入库”的极速录入问题。
- 在不增加一线人员负担的前提下，积累结构化数据（品名、品类、单位、箱规）。
- 为后续 RMS / POS / BMS 等系统提供干净、可用的物料与流转数据基础。
- 实现基础出库管理（门店领料 / 调拨 / 退货等）及实时库存查询与调整。

## 2. 设计目标与原则
### 2.1 核心目标
- **预计收货记录**: 记录即将到货的物料信息。
- **实际入库极速录入**: 支持基于“预计收货单”快速确认或修改数量，并提供纯文本“极速录入”模式。
- **自动归一化**: 小数箱数（如 1.5 箱）在保存时自动转换为标准单位整数（如 15 瓶）。
- **出库记录**: 支持记录门店领料、店间调拨、退货、报废等出库动作。
- **库存管理**: 支持单个SKU的库存盘点、调整及历史履历追溯。
- **AI 辅助导入**: 支持粘贴文本块，系统自动解析 `[品名]|[箱规]|[单位]|[品类]` 格式。
- **Self-Healing (自愈)**: 数据库表缺失或结构不对时，系统尝试自动修复。

### 2.2 设计原则
- **输入框优先、选择框辅助**: 核心信息以文本输入为主，避免强制下拉。
- **允许不完美，但可逐步变好**: 允许先以“模糊/自然语言”录入，后续再做归一化。
- **自动状态流转**: 批次状态从 `Draft` -> `Receiving` -> `Confirmed` 自动流转。
- **防止系统成为“黑箱”**: 所有自动推断必须保留可追溯记录。

## 3. 系统状态与近期更新
**当前状态**: Phase 1 (Inbound), Phase 2 (Outbound), Phase 3 (Inventory) 已全部完成。
**最近更新 (2025-11-25)**:
系统进行了一次全面的UI功能修复，解决了前期版本中存在的多个应用层Bug。所有核心功能，包括**入库合并确认**、**查看原始记录**、SKU管理、品类管理等模块的按钮和表单交互问题均已修复。系统当前版本稳定，可用于生产环境。

## 4. 业务流程与操作协议
### 4.1 系统接入点
- **前台 (极速录入):** `https://[Domain]/mrs/`
- **后台 (合并/管理):** `https://[Domain]/mrs/backend.php`

### 4.2 操作核心原则
- **一线人员**: “录你所见”。看到65瓶就录65瓶，不要心算换算成箱。
- **后台人员**: “确认前核对”。在合并确认页面，检查系统自动换算的箱数和散件数是否合理，如有疑问应手动修改后再确认。

### 4.3 入库流程
1.  **创建批次**: 后台或前台创建收货批次 (状态: Draft)。
2.  **录入数据**: 操作员录入收货记录。此时，批次状态自动变为 Receiving。
3.  **合并确认**: 后台管理员进入“合并确认”页面，系统会按SKU自动聚合原始记录。管理员可调整最终确认数量，然后点击“确认”或“全部确认”，完成数据入库。

### 4.4 出库流程
1.  **新建出库单**: 后台创建出库单 (状态: Draft)。
2.  **添加明细**: 选择SKU，输入出库数量。
3.  **确认出库**: 点击“确认”后，状态变为 Confirmed，库存正式扣减。

### 4.5 库存调整流程
1.  **发起盘点**: 在SKU列表中，针对特定物料发起“盘点/调整”。
2.  **输入实际库存**: 用户输入实际盘点数量。
3.  **确认调整**: 系统自动计算差异，生成调整记录，直接影响库存。

## 5. 功能范围 (已实现)
- **收货入库**: 快速收货、批次管理、批量导入、AI辅助。
- **出库管理**: 出库单管理、多类型支持、库存联动。
- **库存与数据管理**: Dashboard、物料主数据(SKU)、库存盘点、SKU履历、系统自愈维护。

## 6. 系统设计简述
### 6.1 数据库核心表
- **收货**: `mrs_batch` (批次), `mrs_batch_raw_record` (原始记录), `mrs_batch_confirmed_item` (确认后明细)。
- **出库**: `mrs_outbound_order` (出库单), `mrs_outbound_order_item` (出库明细)。
- **基础数据**: `mrs_sku` (物料), `mrs_category` (品类), `sys_users` (用户)。

### 6.2 关键逻辑：自动归一化 (Auto-Normalization)
系统在存储数量时，会将前端输入的小数箱数（如 1.5 箱）根据SKU箱规（如 1 箱 = 10 个）自动计算为总标准单位数（15 个）并存储，确保库存计算的准确性。

### 6.3 部署与架构
- **前端入口**: `/dc_html/mrs/` (index.php, backend.php, api.php)
- **后端逻辑**: `/app/mrs/` (api/, lib/, config_mrs/)
- **API网关**: 所有请求通过 `api.php?route=...` 转发，对路由参数进行白名单校验。
- **访问控制**: 核心API文件检查 `defined('MRS_ENTRY')` 防止直接访问。

### 6.4 安全机制
- **密码存储**: 使用 `password_hash()` (Bcrypt) 算法。
- **会话管理**: 会话Cookie配置为 `HTTPOnly`, `Secure`, `SameSite=Strict`，并使用 `session_regenerate_id()` 防护会话固定。
- **XSS防护**: 前端渲染动态数据时统一使用 `escapeHtml` 函数转义。

## 7. 未来计划
- **用户管理**: 开发用户增删改查的UI界面。
- **报表功能**: 完善统计报表功能的后端逻辑。
- **“记住我”功能**: 重新设计并实现安全的“记住我”登录验证机制。
- **前端代码重构**: 对 `backend.js` 进行模块化重构，降低耦合度。
