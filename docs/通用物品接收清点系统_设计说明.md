# 通用物品接收清点系统 - 系统设计说明

**系统名称**: Generic Package Reception & Count System (GPRCS)
**原名称**: Express快递签收清点系统
**文档版本**: v1.0
**编写日期**: 2025-12-16
**系统版本**: GPRCS v1.0
**适用对象**: 系统架构师、开发工程师、数据库管理员

---

## 目录

1. [系统概述](#1-系统概述)
2. [系统架构设计](#2-系统架构设计)
3. [数据库设计](#3-数据库设计)
4. [功能模块设计](#4-功能模块设计)
5. [接口设计](#5-接口设计)
6. [前端设计](#6-前端设计)
7. [安全设计](#7-安全设计)
8. [技术栈](#8-技术栈)
9. [部署架构](#9-部署架构)
10. [性能优化](#10-性能优化)

---

## 1. 系统概述

### 1.1 系统定位

**通用物品接收清点系统（GPRCS）**是一个专业的仓库收货管理平台，专注于物品的接收、核实、清点和内容记录等核心业务。系统支持批次管理、快速操作、产品明细、保质期管理等高级功能，适用于食品、药品、日用品等各类需要严格清点的物品管理场景。

**系统更名说明**:
- **原名称**: Express快递签收清点系统
- **新名称**: 通用物品接收清点系统
- **更名原因**: 系统不限于快递包裹，可处理任何物品的接收清点，"通用物品"更准确地描述了系统的适用范围

### 1.2 系统特点

- **快速**: 前台快速操作页面，支持手机扫码，0延迟反馈
- **准确**: 产品明细、保质期、操作人完整追踪
- **灵活**: 支持自定义包裹、批量导入、多产品明细
- **可追踪**: 完整的操作日志，支持历史查询
- **多角色**: 前台操作员 + 后台管理员双层设计

### 1.3 核心业务流程

```
创建批次 → 导入快递单号 → 前台快速操作 → 数据统计
    ↓          ↓              ↓              ↓
批次管理   批量导入         核实清点       后台分析
           自定义包裹       多产品支持     历史查询
```

### 1.4 三核心操作

**核实（Verify）**:
- 确认包裹存在
- 状态: pending → verified
- 记录核实时间和操作人

**清点（Count）**:
- 记录包裹内容、数量、保质期
- 支持多产品明细（一个包裹多种产品）
- 状态: pending/verified → counted
- 记录清点时间和操作人

**调整（Adjust）**:
- 修正清点结果
- 填写调整原因
- 状态: counted/adjusted → adjusted
- 记录调整时间和操作人

### 1.5 与MRS系统的关系

```
业务流程:

Express系统（本系统）→ MRS系统
       ↓                    ↓
1. 快递签收清点         3. 库存管理
2. 记录内容和保质期     4. 出库核销
                        5. 统计分析

数据共享:
- 用户认证表（sys_users）共享
- MRS从Express批次中导入已清点包裹
- 两系统可独立迁移部署
```

---

## 2. 系统架构设计

### 2.1 整体架构

系统采用**前后端分离 + 双端设计**架构：

```
┌──────────────────────────────────────────────────────────┐
│                  Presentation Layer                       │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  前台（dc_html/express/）- 移动端友好               │ │
│  │  - index.php (前台路由)                             │ │
│  │  - quick_ops.js (850+ 行，快速操作逻辑)            │ │
│  │  - quick_ops.css (移动优先样式)                    │ │
│  └─────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  后台（dc_html/express/exp/）- PC端管理             │ │
│  │  - index.php (后台路由)                             │ │
│  │  - modal.js (现代化模态框组件)                     │ │
│  │  - backend.css (后台样式)                          │ │
│  └─────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
                         ↓ HTTP Request
┌──────────────────────────────────────────────────────────┐
│                   Application Layer                       │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  app/express/  (应用逻辑层)                         │ │
│  │  - bootstrap.php (系统初始化)                       │ │
│  │  - lib/express_lib.php (核心业务库 - 1250+ 行)     │ │
│  │  - views/ (后台视图 - 8个页面)                     │ │
│  │  - api/ (后台API - 10个接口)                       │ │
│  │  - actions/ (前台API - 9个接口)                    │ │
│  └─────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
                         ↓ PDO
┌──────────────────────────────────────────────────────────┐
│                     Data Layer                            │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  MySQL 8.4.6 Database                                │ │
│  │  - express_*表 (4张核心表)                          │ │
│  │  - sys_users (共享用户表)                           │ │
│  │  - 外键级联 + 索引优化                              │ │
│  └─────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
```

### 2.2 双端设计说明

**前台（Front-end）**:
- **用户**: 仓库操作员、收货员
- **设备**: 手机、平板（移动优先）
- **场景**: 现场快速操作（扫码清点）
- **特点**: 大按钮、简化流程、实时反馈

**后台（Back-end）**:
- **用户**: 仓库管理员、业务主管
- **设备**: PC、笔记本
- **场景**: 批次管理、数据分析、历史查询
- **特点**: 完整功能、详细信息、批量操作

### 2.3 目录结构设计

```
/home/user/mrscodx/
├── app/express/                          # Express后端应用
│   ├── bootstrap.php                     # 系统启动入口
│   ├── config_express/
│   │   └── env_express.php              # 配置文件（DB、路径）
│   ├── lib/
│   │   └── express_lib.php              # 核心业务库（1250+ 行，30+函数）
│   ├── views/                            # 后台视图（8个页面）
│   │   ├── login.php                    # 登录页
│   │   ├── batch_list.php               # 批次列表
│   │   ├── batch_detail.php             # 批次详情
│   │   ├── batch_create.php             # 创建批次
│   │   ├── batch_edit.php               # 编辑批次
│   │   ├── batch_print.php              # 批次打印
│   │   ├── content_search.php           # 物品搜索
│   │   └── shared/
│   │       └── sidebar.php              # 侧边栏导航
│   ├── api/                              # 后台API（10个文件）
│   │   ├── do_login.php                 # 登录处理
│   │   ├── batch_create_save.php        # 创建批次
│   │   ├── batch_edit_save.php          # 编辑批次
│   │   ├── batch_delete.php             # 删除批次
│   │   ├── bulk_import_save.php         # 批量导入
│   │   ├── create_custom_packages.php   # 创建自定义包裹
│   │   ├── update_content_note.php      # 更新内容
│   │   ├── get_package_items.php        # 获取产品明细
│   │   ├── get_product_expiry.php       # 获取保质期建议
│   │   └── content_search_api.php       # 内容搜索
│   └── actions/                          # 前台API（9个文件）
│       ├── quick_ops.php                # 快速操作页面（主页面）
│       ├── save_record_api.php          # 保存操作记录
│       ├── get_batches_api.php          # 获取批次列表
│       ├── get_batch_detail_api.php     # 获取批次详情
│       ├── get_packages_api.php         # 获取包裹列表
│       ├── search_tracking_api.php      # 搜索快递单号
│       ├── get_recent_operations_api.php# 获取操作历史
│       ├── get_product_expiry_api.php   # 获取产品保质期
│       └── search_content_note_api.php  # 搜索内容备注
├── dc_html/express/                      # Express前端资源
│   ├── index.php                        # 前台路由入口
│   ├── css/
│   │   └── quick_ops.css                # 前台操作页样式（移动优先）
│   ├── js/
│   │   └── quick_ops.js                 # 前台逻辑（850+ 行）
│   └── exp/                             # 后台子目录
│       ├── index.php                    # 后台路由入口
│       ├── css/
│       │   ├── backend.css              # 后台主样式
│       │   └── modal.css                # 模态框样式
│       └── js/
│           └── modal.js                 # 模态框组件（Promise）
└── logs/express/                         # 日志目录
    ├── debug.log                        # 调试日志
    └── error.log                        # 错误日志
```

### 2.4 路由设计

**前台路由** (`dc_html/express/index.php`):
```php
$action = $_GET['action'] ?? 'quick_ops';

$allowed_actions = [
    'quick_ops',                      // 快速操作页面（默认）
    'save_record_api',                // 保存记录
    'get_batches_api',                // 获取批次
    'get_batch_detail_api',           // 批次详情
    'get_packages_api',               // 包裹列表
    'search_tracking_api',            // 搜索单号
    'get_recent_operations_api',      // 操作历史
    'get_product_expiry_api',         // 保质期建议
    'search_content_note_api'         // 搜索内容
];
```

**后台路由** (`dc_html/express/exp/index.php`):
```php
$action = $_GET['action'] ?? 'batch_list';

$allowed_actions = [
    // 认证
    'login', 'do_login', 'logout',

    // 批次管理
    'batch_list', 'batch_detail', 'batch_create', 'batch_edit',
    'batch_delete', 'batch_print',
    'batch_create_save', 'batch_edit_save',

    // 包裹管理
    'bulk_import', 'bulk_import_save',
    'create_custom_packages',
    'update_content_note',
    'get_package_items',
    'get_product_expiry',

    // 搜索
    'content_search', 'content_search_api'
];
```

### 2.5 数据流设计

#### 清点操作数据流
```
前台输入快递单号
    ↓
实时搜索（防抖0.5秒）
    ↓
POST /express/?action=save_record_api
    ↓
express_process_package($pdo, $batch_id, $tracking_number, 'count', ...)
    ↓
BEGIN TRANSACTION
    ├─ 查找or创建package记录
    ├─ express_process_count() 更新状态
    ├─ 保存产品明细到 express_package_items
    ├─ 记录操作日志到 express_operation_log
    └─ 更新批次统计 express_update_batch_statistics()
COMMIT
    ↓
返回JSON {success, package, batch, message}
    ↓
前台更新UI
    ├─ 清空表单
    ├─ 刷新操作历史
    ├─ 更新批次统计进度条
    └─ 焦点回到输入框
```

---

## 3. 数据库设计

### 3.1 数据库概览

**数据库名称**: `mhdlmskp2kpxguj`
**字符集**: utf8mb4
**排序规则**: utf8mb4_unicode_ci
**数据库引擎**: InnoDB
**数据库版本**: MySQL 8.4.6

**表统计**:
- **核心业务表**: 4张
- **共享表**: 1张（sys_users）
- **总计**: 5张表

### 3.2 核心表设计

#### 3.2.1 批次表 (express_batch)

**用途**: 管理快递批次，每个批次包含多个包裹

```sql
CREATE TABLE `express_batch` (
  `batch_id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '批次ID',
  `batch_name` VARCHAR(100) NOT NULL COMMENT '批次名称（手工录入）',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `created_by` VARCHAR(50) DEFAULT NULL COMMENT '创建人',
  `status` ENUM('active','closed') NOT NULL DEFAULT 'active' COMMENT '批次状态',
  `total_count` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '总包裹数',
  `verified_count` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '已核实数',
  `counted_count` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '已清点数',
  `adjusted_count` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '已调整数',
  `notes` TEXT COMMENT '备注',
  PRIMARY KEY (`batch_id`),
  UNIQUE KEY `uk_batch_name` (`batch_name`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**关键设计**:
- `batch_name`: 唯一索引，防止批次名称重复
- `status`: 两状态机（active活动中 / closed已关闭）
- `*_count`: 冗余统计字段，避免频繁聚合查询
- 统计字段自动维护（通过触发器或应用层更新）

#### 3.2.2 包裹表 (express_package)

**用途**: 记录批次中的每个包裹及其清点信息

```sql
CREATE TABLE `express_package` (
  `package_id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '包裹ID',
  `batch_id` INT UNSIGNED NOT NULL COMMENT '批次ID',
  `tracking_number` VARCHAR(100) NOT NULL COMMENT '快递单号',
  `package_status` ENUM('pending','verified','counted','adjusted') NOT NULL DEFAULT 'pending' COMMENT '包裹状态',
  `content_note` TEXT COMMENT '内容备注（清点时填写）',
  `expiry_date` DATE DEFAULT NULL COMMENT '保质期（非生产日期，选填）',
  `quantity` INT UNSIGNED DEFAULT NULL COMMENT '数量（选填）',
  `adjustment_note` TEXT COMMENT '调整备注',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `verified_at` DATETIME DEFAULT NULL COMMENT '核实时间',
  `counted_at` DATETIME DEFAULT NULL COMMENT '清点时间',
  `adjusted_at` DATETIME DEFAULT NULL COMMENT '调整时间',
  `verified_by` VARCHAR(50) DEFAULT NULL COMMENT '核实人',
  `counted_by` VARCHAR(50) DEFAULT NULL COMMENT '清点人',
  `adjusted_by` VARCHAR(50) DEFAULT NULL COMMENT '调整人',
  PRIMARY KEY (`package_id`),
  UNIQUE KEY `uk_tracking_batch` (`tracking_number`, `batch_id`),
  KEY `idx_batch_id` (`batch_id`),
  KEY `idx_tracking_number` (`tracking_number`),
  KEY `idx_package_status` (`package_status`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_expiry_date` (`expiry_date`),
  CONSTRAINT `fk_package_batch` FOREIGN KEY (`batch_id`)
    REFERENCES `express_batch` (`batch_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**关键设计**:
- **四状态机**:
  - `pending`: 待处理（导入后的初始状态）
  - `verified`: 已核实（确认包裹存在）
  - `counted`: 已清点（记录了内容信息）
  - `adjusted`: 已调整（修正了清点结果）
- **联合唯一索引**: (`tracking_number`, `batch_id`) 防止同一批次重复快递单号
- **时间戳追踪**: 记录每个操作的时间和操作人
- **级联删除**: 删除批次时自动删除关联包裹

#### 3.2.3 包裹产品明细表 (express_package_items)

**用途**: 支持单个包裹包含多种产品的详细记录

```sql
CREATE TABLE `express_package_items` (
  `item_id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '明细ID',
  `package_id` INT UNSIGNED NOT NULL COMMENT '包裹ID',
  `product_name` VARCHAR(200) DEFAULT NULL COMMENT '产品名称/内容备注',
  `quantity` INT UNSIGNED DEFAULT NULL COMMENT '数量',
  `expiry_date` DATE DEFAULT NULL COMMENT '保质期',
  `sort_order` INT DEFAULT 0 COMMENT '排序',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`item_id`),
  KEY `idx_package_id` (`package_id`),
  KEY `idx_expiry_date` (`expiry_date`),
  CONSTRAINT `fk_item_package` FOREIGN KEY (`package_id`)
    REFERENCES `express_package` (`package_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**关键设计**:
- **1:N关系**: 一个包裹可有多个产品明细
- **级联删除**: 删除包裹时自动删除产品明细
- **sort_order**: 支持产品显示顺序控制
- **灵活性**: product_name、quantity、expiry_date都可选

#### 3.2.4 操作日志表 (express_operation_log)

**用途**: 完整的操作审计日志

```sql
CREATE TABLE `express_operation_log` (
  `log_id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `package_id` INT UNSIGNED NOT NULL COMMENT '包裹ID',
  `operation_type` ENUM('verify','count','adjust','create_custom','update_content') NOT NULL COMMENT '操作类型',
  `operation_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  `operator` VARCHAR(50) DEFAULT NULL COMMENT '操作人',
  `old_status` VARCHAR(20) DEFAULT NULL COMMENT '旧状态',
  `new_status` VARCHAR(20) NOT NULL COMMENT '新状态',
  `notes` TEXT COMMENT '备注',
  PRIMARY KEY (`log_id`),
  KEY `idx_package_id` (`package_id`),
  KEY `idx_operation_type` (`operation_type`),
  KEY `idx_operation_time` (`operation_time`),
  CONSTRAINT `fk_log_package` FOREIGN KEY (`package_id`)
    REFERENCES `express_package` (`package_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**关键设计**:
- **五种操作类型**:
  - `verify`: 核实操作
  - `count`: 清点操作
  - `adjust`: 调整操作
  - `create_custom`: 创建自定义包裹
  - `update_content`: 更新内容
- **状态变化追踪**: 记录old_status和new_status
- **级联删除**: 删除包裹时自动删除日志
- **只增不删**: 日志表只INSERT，不DELETE

### 3.3 数据库关系图

```
sys_users (共享)
    ↓ (user_login)
[用户认证与会话]

express_batch
    ↓ (batch_id)
express_package (1:N)
    ↓ (package_id)
    ├─→ express_package_items (1:N)
    └─→ express_operation_log (1:N)
```

**级联删除链**:
```
删除批次 → 删除包裹 → 删除产品明细 + 删除操作日志
```

### 3.4 索引设计策略

#### 主键索引
所有表使用 AUTO_INCREMENT 主键，类型为 INT UNSIGNED

#### 唯一索引
```sql
-- 防止批次名称重复
UNIQUE KEY `uk_batch_name` (`batch_name`)

-- 防止同一批次重复快递单号
UNIQUE KEY `uk_tracking_batch` (`tracking_number`, `batch_id`)
```

#### 普通索引
```sql
-- 批次查询优化
KEY `idx_status` (`status`)
KEY `idx_created_at` (`created_at`)

-- 包裹查询优化
KEY `idx_batch_id` (`batch_id`)
KEY `idx_package_status` (`package_status`)
KEY `idx_tracking_number` (`tracking_number`)
KEY `idx_expiry_date` (`expiry_date`)

-- 日志查询优化
KEY `idx_operation_type` (`operation_type`)
KEY `idx_operation_time` (`operation_time`)
```

### 3.5 外键约束设计

**级联删除场景**:
```sql
-- 删除批次时自动删除包裹
ALTER TABLE `express_package`
  ADD CONSTRAINT `fk_package_batch`
  FOREIGN KEY (`batch_id`) REFERENCES `express_batch` (`batch_id`)
  ON DELETE CASCADE;

-- 删除包裹时自动删除产品明细
ALTER TABLE `express_package_items`
  ADD CONSTRAINT `fk_item_package`
  FOREIGN KEY (`package_id`) REFERENCES `express_package` (`package_id`)
  ON DELETE CASCADE;

-- 删除包裹时自动删除操作日志
ALTER TABLE `express_operation_log`
  ADD CONSTRAINT `fk_log_package`
  FOREIGN KEY (`package_id`) REFERENCES `express_package` (`package_id`)
  ON DELETE CASCADE;
```

**数据完整性保证**:
- 不能创建不存在批次的包裹
- 不能为不存在包裹添加产品明细
- 删除批次会清理所有关联数据

---

## 4. 功能模块设计

### 4.1 批次管理模块

#### 4.1.1 创建批次

**功能**: 创建新的快递批次

**输入参数**:
```json
{
    "batch_name": "2025-12-16批次A",
    "notes": "供应商A发货",
    "created_by": "admin"
}
```

**核心函数** (express_lib.php:155-203):
```php
function express_create_batch($pdo, $data) {
    try {
        $stmt = $pdo->prepare("
            INSERT INTO express_batch
            (batch_name, notes, created_by, status,
             total_count, verified_count, counted_count, adjusted_count)
            VALUES (?, ?, ?, 'active', 0, 0, 0, 0)
        ");

        $stmt->execute([
            $data['batch_name'],
            $data['notes'] ?? '',
            $data['created_by'] ?? ''
        ]);

        $batch_id = $pdo->lastInsertId();

        express_log('INFO', "创建批次成功: ID={$batch_id}, 名称={$data['batch_name']}");

        return [
            'success' => true,
            'data' => ['batch_id' => $batch_id],
            'message' => '批次创建成功'
        ];

    } catch (PDOException $e) {
        if ($e->getCode() == 23000) {  // 重复键错误
            return ['success' => false, 'message' => '批次名称已存在'];
        }
        express_log('ERROR', "创建批次失败: " . $e->getMessage());
        return ['success' => false, 'message' => '创建批次失败'];
    }
}
```

**业务规则**:
- 批次名称必须唯一
- 初始状态为 active
- 初始统计为全0

#### 4.1.2 批量导入快递单号

**功能**: 从文本批量导入快递单号到指定批次

**输入格式**:
```
SF1234567890
YTO9876543210|2026-06-15|100
JD1122334455||50
```

**格式说明**:
- 每行一个快递单号
- 可选: 单号|保质期|数量
- 保质期格式: YYYY-MM-DD
- 数量为整数

**核心函数** (express_lib.php:553-630):
```php
function express_bulk_import($pdo, $batch_id, $tracking_numbers_text) {
    $lines = explode("\n", trim($tracking_numbers_text));
    $imported = 0;
    $duplicates = 0;
    $errors = [];

    try {
        $pdo->beginTransaction();

        foreach ($lines as $line) {
            $line = trim($line);
            if (empty($line)) continue;

            // 解析行: 单号|保质期|数量
            $parts = explode('|', $line);
            $tracking_number = trim($parts[0]);
            $expiry_date = isset($parts[1]) && trim($parts[1]) !== ''
                         ? trim($parts[1]) : null;
            $quantity = isset($parts[2]) && trim($parts[2]) !== ''
                      ? intval(trim($parts[2])) : null;

            // 验证保质期格式
            if ($expiry_date && !preg_match('/^\d{4}-\d{2}-\d{2}$/', $expiry_date)) {
                $errors[] = "{$tracking_number}: 保质期格式错误";
                continue;
            }

            // 创建包裹
            $result = express_create_package($pdo, [
                'batch_id' => $batch_id,
                'tracking_number' => $tracking_number,
                'expiry_date' => $expiry_date,
                'quantity' => $quantity
            ]);

            if ($result['success']) {
                $imported++;
            } elseif (strpos($result['message'], '已存在') !== false) {
                $duplicates++;
            } else {
                $errors[] = "{$tracking_number}: {$result['message']}";
            }
        }

        $pdo->commit();

        return [
            'success' => true,
            'data' => [
                'imported' => $imported,
                'duplicates' => $duplicates,
                'errors' => $errors
            ],
            'message' => "成功导入 {$imported} 个包裹"
        ];

    } catch (PDOException $e) {
        $pdo->rollBack();
        express_log('ERROR', "批量导入失败: " . $e->getMessage());
        return ['success' => false, 'message' => '批量导入失败'];
    }
}
```

**业务规则**:
- 忽略空行
- 重复单号计数但不报错
- 保质期格式错误跳过该行
- 全部在事务中执行

#### 4.1.3 创建自定义包裹

**功能**: 为一个快递箱创建多个逻辑包裹

**使用场景**:
- 一个快递箱包含多个产品
- 需要分开记录每个产品
- 快递单号不够用时

**核心函数** (express_lib.php:632-703):
```php
function express_create_custom_packages($pdo, $batch_id, $count) {
    // 获取下一个自定义编号
    $stmt = $pdo->prepare("
        SELECT MAX(CAST(SUBSTRING(tracking_number, LENGTH(:prefix) + 1) AS UNSIGNED)) as max_num
        FROM express_package
        WHERE batch_id = :batch_id
          AND tracking_number LIKE CONCAT(:prefix, '%')
    ");

    $prefix = "CUSTOM-{$batch_id}-";
    $stmt->execute([
        'prefix' => $prefix,
        'batch_id' => $batch_id
    ]);

    $max_num = $stmt->fetchColumn() ?? 0;

    $created = [];
    $errors = [];

    try {
        $pdo->beginTransaction();

        for ($i = 1; $i <= $count; $i++) {
            $num = $max_num + $i;
            $tracking_number = $prefix . str_pad($num, 4, '0', STR_PAD_LEFT);

            $result = express_create_package($pdo, [
                'batch_id' => $batch_id,
                'tracking_number' => $tracking_number
            ]);

            if ($result['success']) {
                $created[] = [
                    'package_id' => $result['data']['package_id'],
                    'tracking_number' => $tracking_number
                ];
            } else {
                $errors[] = $tracking_number;
            }
        }

        $pdo->commit();

        return [
            'success' => true,
            'data' => [
                'created' => $created,
                'errors' => $errors
            ],
            'message' => "成功创建 " . count($created) . " 个自定义包裹"
        ];

    } catch (PDOException $e) {
        $pdo->rollBack();
        express_log('ERROR', "创建自定义包裹失败: " . $e->getMessage());
        return ['success' => false, 'message' => '创建自定义包裹失败'];
    }
}
```

**编号格式**:
```
CUSTOM-{batch_id}-{序号}
例: CUSTOM-5-0001, CUSTOM-5-0002, ...
```

**业务规则**:
- 编号自动递增
- 初始状态为 pending
- 需要手工清点填写内容

### 4.2 包裹操作模块

#### 4.2.1 核实操作

**功能**: 确认包裹存在，状态变为verified

**状态转换**:
```
pending → verified
```

**核心函数** (express_lib.php:968-1006):
```php
function express_process_verify($pdo, $package_id, $operator) {
    try {
        $stmt = $pdo->prepare("
            UPDATE express_package
            SET package_status = 'verified',
                verified_at = NOW(),
                verified_by = ?
            WHERE package_id = ?
              AND package_status = 'pending'
        ");

        $stmt->execute([$operator, $package_id]);

        if ($stmt->rowCount() == 0) {
            return [
                'success' => false,
                'message' => '包裹不存在或状态不正确'
            ];
        }

        return [
            'success' => true,
            'new_status' => 'verified',
            'message' => '核实成功'
        ];

    } catch (PDOException $e) {
        express_log('ERROR', "核实失败: " . $e->getMessage());
        return ['success' => false, 'message' => '核实失败'];
    }
}
```

**业务规则**:
- 只能核实 pending 状态的包裹
- 记录核实时间和操作人
- 不需要填写内容信息

#### 4.2.2 清点操作

**功能**: 记录包裹内容、数量、保质期等详细信息

**状态转换**:
```
pending → counted
verified → counted
```

**核心函数** (express_lib.php:1042-1122):
```php
function express_process_count($pdo, $package_id, $operator, $content_note,
                                $expiry_date = null, $quantity = null, $products = null) {
    try {
        // 1. 更新包裹状态为 counted
        $stmt = $pdo->prepare("
            UPDATE express_package
            SET package_status = 'counted',
                verified_at = COALESCE(verified_at, NOW()),
                counted_at = NOW(),
                counted_by = ?,
                content_note = ?,
                expiry_date = ?,
                quantity = ?
            WHERE package_id = ?
        ");

        $stmt->execute([
            $operator,
            $content_note,
            $expiry_date,
            $quantity,
            $package_id
        ]);

        // 2. 保存产品明细（如果有）
        if ($products && is_array($products)) {
            // 删除旧明细
            $delete_stmt = $pdo->prepare("
                DELETE FROM express_package_items
                WHERE package_id = ?
            ");
            $delete_stmt->execute([$package_id]);

            // 插入新明细
            $insert_stmt = $pdo->prepare("
                INSERT INTO express_package_items
                (package_id, product_name, quantity, expiry_date, sort_order)
                VALUES (?, ?, ?, ?, ?)
            ");

            foreach ($products as $idx => $item) {
                $insert_stmt->execute([
                    $package_id,
                    $item['product_name'] ?? '',
                    $item['quantity'] ?? null,
                    $item['expiry_date'] ?? null,
                    $idx
                ]);
            }
        }

        return [
            'success' => true,
            'new_status' => 'counted',
            'message' => '清点成功'
        ];

    } catch (PDOException $e) {
        express_log('ERROR', "清点失败: " . $e->getMessage());
        return ['success' => false, 'message' => '清点失败'];
    }
}
```

**业务规则**:
- 可从 pending 或 verified 状态清点
- 必填: content_note（内容备注）
- 可选: expiry_date（保质期）、quantity（数量）、products（产品明细）
- 支持多产品明细（覆盖式保存）
- 自动填充 verified_at（如果之前未核实）

#### 4.2.3 调整操作

**功能**: 修正清点结果，填写调整原因

**状态转换**:
```
counted → adjusted
adjusted → adjusted
```

**核心函数** (express_lib.php:1124-1164):
```php
function express_process_adjust($pdo, $package_id, $operator, $adjustment_note) {
    try {
        $stmt = $pdo->prepare("
            UPDATE express_package
            SET package_status = 'adjusted',
                adjusted_at = NOW(),
                adjusted_by = ?,
                adjustment_note = ?
            WHERE package_id = ?
              AND package_status IN ('counted', 'adjusted')
        ");

        $stmt->execute([$operator, $adjustment_note, $package_id]);

        if ($stmt->rowCount() == 0) {
            return [
                'success' => false,
                'message' => '包裹不存在或状态不正确（必须是counted或adjusted）'
            ];
        }

        return [
            'success' => true,
            'new_status' => 'adjusted',
            'message' => '调整成功'
        ];

    } catch (PDOException $e) {
        express_log('ERROR', "调整失败: " . $e->getMessage());
        return ['success' => false, 'message' => '调整失败'];
    }
}
```

**业务规则**:
- 只能调整 counted 或 adjusted 状态的包裹
- 必须填写调整原因
- 可以多次调整
- 保留调整时间和操作人

### 4.3 查询与搜索模块

#### 4.3.1 模糊搜索快递单号

**功能**: 在指定批次中模糊搜索快递单号

**核心函数** (express_lib.php:387-448):
```php
function express_search_tracking($pdo, $batch_id, $keyword) {
    try {
        $sql = "
            SELECT p.*,
                   GROUP_CONCAT(i.product_name ORDER BY i.sort_order SEPARATOR ', ') as products
            FROM express_package p
            LEFT JOIN express_package_items i ON p.package_id = i.package_id
            WHERE p.batch_id = :batch_id
              AND p.tracking_number LIKE :keyword
            GROUP BY p.package_id
            ORDER BY p.created_at DESC
            LIMIT 20
        ";

        $stmt = $pdo->prepare($sql);
        $stmt->execute([
            'batch_id' => $batch_id,
            'keyword' => "%{$keyword}%"
        ]);

        $packages = $stmt->fetchAll(PDO::FETCH_ASSOC);

        // 为每个包裹加载详细的产品明细
        foreach ($packages as &$package) {
            $items = express_get_package_items($pdo, $package['package_id']);
            $package['items'] = $items;
        }

        return $packages;

    } catch (PDOException $e) {
        express_log('ERROR', "搜索单号失败: " . $e->getMessage());
        return [];
    }
}
```

**搜索特点**:
- 模糊匹配（LIKE %keyword%）
- 限制返回20条
- 包含产品明细（JOIN）
- 按创建时间倒序

#### 4.3.2 搜索内容备注（跨批次）

**功能**: 在所有批次中搜索包含关键词的内容备注

**核心函数** (express_lib.php:482-529):
```php
function express_search_content_note($pdo, $keyword) {
    try {
        $sql = "
            SELECT DISTINCT
                p.content_note,
                p.tracking_number,
                b.batch_name,
                p.counted_at
            FROM express_package p
            INNER JOIN express_batch b ON p.batch_id = b.batch_id
            WHERE p.content_note IS NOT NULL
              AND p.content_note != ''
              AND p.content_note LIKE :keyword
            ORDER BY p.counted_at DESC
            LIMIT 50
        ";

        $stmt = $pdo->prepare($sql);
        $stmt->execute(['keyword' => "%{$keyword}%"]);

        return $stmt->fetchAll(PDO::FETCH_ASSOC);

    } catch (PDOException $e) {
        express_log('ERROR', "搜索内容失败: " . $e->getMessage());
        return [];
    }
}
```

**搜索特点**:
- 跨批次搜索
- 去重显示（DISTINCT content_note）
- 限制返回50条
- 按清点时间倒序

#### 4.3.3 获取产品保质期建议

**功能**: 在指定批次中查找某产品最常用的保质期

**使用场景**:
- 清点时自动填充保质期
- 减少手工输入错误

**核心函数** (express_lib.php:748-786):
```php
function express_get_product_expiry($pdo, $batch_id, $product_name) {
    try {
        $sql = "
            SELECT
                expiry_date,
                COUNT(*) as usage_count
            FROM express_package_items
            WHERE package_id IN (
                SELECT package_id FROM express_package WHERE batch_id = :batch_id
            )
            AND product_name = :product_name
            AND expiry_date IS NOT NULL
            GROUP BY expiry_date
            ORDER BY usage_count DESC
            LIMIT 1
        ";

        $stmt = $pdo->prepare($sql);
        $stmt->execute([
            'batch_id' => $batch_id,
            'product_name' => $product_name
        ]);

        $result = $stmt->fetch(PDO::FETCH_ASSOC);

        if ($result) {
            return [
                'expiry_date' => $result['expiry_date'],
                'usage_count' => $result['usage_count']
            ];
        }

        return null;

    } catch (PDOException $e) {
        express_log('ERROR', "获取保质期建议失败: " . $e->getMessage());
        return null;
    }
}
```

**业务逻辑**:
- 统计该批次中该产品的所有保质期
- 按使用次数降序排序
- 返回最常用的保质期

### 4.4 统计分析模块

#### 4.4.1 批次统计更新

**功能**: 更新批次的统计字段（total_count、verified_count等）

**触发时机**:
- 创建包裹时
- 核实包裹时
- 清点包裹时
- 调整包裹时

**核心函数** (express_lib.php:205-267):
```php
function express_update_batch_statistics($pdo, $batch_id) {
    try {
        $stats = $pdo->prepare("
            SELECT
                COUNT(*) as total,
                SUM(CASE WHEN package_status = 'verified' THEN 1 ELSE 0 END) as verified,
                SUM(CASE WHEN package_status = 'counted' THEN 1 ELSE 0 END) as counted,
                SUM(CASE WHEN package_status = 'adjusted' THEN 1 ELSE 0 END) as adjusted
            FROM express_package
            WHERE batch_id = ?
        ");
        $stats->execute([$batch_id]);
        $result = $stats->fetch(PDO::FETCH_ASSOC);

        $update = $pdo->prepare("
            UPDATE express_batch
            SET total_count = ?,
                verified_count = ?,
                counted_count = ?,
                adjusted_count = ?
            WHERE batch_id = ?
        ");

        $update->execute([
            $result['total'],
            $result['verified'],
            $result['counted'],
            $result['adjusted'],
            $batch_id
        ]);

        return true;

    } catch (PDOException $e) {
        express_log('ERROR', "更新批次统计失败: " . $e->getMessage());
        return false;
    }
}
```

**业务规则**:
- 每次包裹操作后调用
- 实时聚合计算
- 冗余存储在express_batch表

#### 4.4.2 获取内容概括

**功能**: 统计批次中已清点包裹的内容备注去重列表

**核心函数** (express_lib.php:450-480):
```php
function express_get_content_summary($pdo, $batch_id) {
    try {
        $sql = "
            SELECT
                content_note,
                COUNT(*) as count
            FROM express_package
            WHERE batch_id = :batch_id
              AND package_status IN ('counted', 'adjusted')
              AND content_note IS NOT NULL
              AND content_note != ''
            GROUP BY content_note
            ORDER BY count DESC
        ";

        $stmt = $pdo->prepare($sql);
        $stmt->execute(['batch_id' => $batch_id]);

        return $stmt->fetchAll(PDO::FETCH_ASSOC);

    } catch (PDOException $e) {
        express_log('ERROR', "获取内容概括失败: " . $e->getMessage());
        return [];
    }
}
```

**返回示例**:
```json
[
    {"content_note": "番茄酱,芝麻油", "count": 15},
    {"content_note": "番茄酱", "count": 10},
    {"content_note": "芝麻油", "count": 8}
]
```

---

## 5. 接口设计

### 5.1 API响应格式

**标准JSON响应**:
```php
function express_json_response($success, $data, $message = '') {
    header('Content-Type: application/json; charset=utf-8');
    echo json_encode([
        'success' => $success,
        'data' => $data,
        'message' => $message
    ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
}
```

**响应示例**:
```json
// 成功
{
    "success": true,
    "data": {
        "batch_id": 5,
        "batch_name": "批次A"
    },
    "message": "批次创建成功"
}

// 失败
{
    "success": false,
    "data": null,
    "message": "批次名称已存在"
}
```

### 5.2 前台API清单

**基础URL**: `/express/?action=`

| 接口 | 方法 | 功能 |
|------|------|------|
| get_batches_api | GET | 获取批次列表 |
| get_batch_detail_api | GET | 获取批次详情 |
| search_tracking_api | GET | 搜索快递单号 |
| get_packages_api | GET | 获取包裹列表 |
| save_record_api | POST | 保存操作记录 |
| get_recent_operations_api | GET | 获取操作历史 |
| get_product_expiry_api | GET | 获取保质期建议 |
| search_content_note_api | GET | 搜索内容备注 |

### 5.3 后台API清单

**基础URL**: `/express/exp/?action=`

| 接口 | 方法 | 功能 |
|------|------|------|
| do_login | POST | 用户登录 |
| logout | GET | 用户登出 |
| batch_create_save | POST | 创建批次 |
| batch_edit_save | POST | 编辑批次 |
| batch_delete | POST | 删除批次 |
| bulk_import_save | POST | 批量导入 |
| create_custom_packages | POST | 创建自定义包裹 |
| update_content_note | POST | 更新内容备注 |
| get_package_items | GET | 获取产品明细 |
| get_product_expiry | GET | 获取保质期建议 |

### 5.4 关键接口详解

#### 5.4.1 保存操作记录API

**请求**:
```
POST /express/?action=save_record_api

Content-Type: application/json

{
    "batch_id": 5,
    "tracking_number": "SF1234567890",
    "operation_type": "count",
    "operator": "admin",
    "content_note": "番茄酱,芝麻油",
    "expiry_date": "2026-06-15",
    "quantity": 100,
    "products": [
        {
            "product_name": "番茄酱",
            "quantity": 50,
            "expiry_date": "2026-06-15"
        },
        {
            "product_name": "芝麻油",
            "quantity": 50,
            "expiry_date": "2026-06-15"
        }
    ]
}
```

**响应**:
```json
{
    "success": true,
    "data": {
        "package": {
            "package_id": 123,
            "tracking_number": "SF1234567890",
            "package_status": "counted"
        },
        "batch": {
            "batch_id": 5,
            "total_count": 50,
            "counted_count": 25
        }
    },
    "message": "清点成功"
}
```

#### 5.4.2 搜索快递单号API

**请求**:
```
GET /express/?action=search_tracking_api&batch_id=5&keyword=SF123
```

**响应**:
```json
{
    "success": true,
    "data": [
        {
            "package_id": 123,
            "tracking_number": "SF1234567890",
            "package_status": "counted",
            "content_note": "番茄酱,芝麻油",
            "items": [
                {
                    "product_name": "番茄酱",
                    "quantity": 50,
                    "expiry_date": "2026-06-15"
                }
            ]
        }
    ],
    "message": ""
}
```

---

## 6. 前端设计

### 6.1 前台快速操作页面

**文件**: `dc_html/express/js/quick_ops.js` (850+行)

**全局状态管理**:
```javascript
const state = {
    currentBatchId: null,           // 当前批次ID
    currentOperation: null,         // 当前操作类型
    searchTimeout: null,            // 搜索防抖定时器
    operationHistory: [],           // 操作历史（最多100条）
    searchResults: new Map(),       // 搜索结果缓存
    lastCountNote: '',              // 上次清点内容
    productItemCounter: 0           // 产品项计数器
};
```

**核心函数**:

| 函数名 | 功能 | 行号 |
|--------|------|------|
| onBatchChange() | 批次选择变化 | 195-223 |
| selectOperation() | 操作类型选择 | 299-319 |
| onTrackingInput() | 快递单号输入（防抖） | 338-392 |
| submitOperation() | 提交操作 | 438-557 |
| refreshBatches() | 刷新批次列表 | 136-181 |
| displayHistory() | 显示操作历史 | 684-767 |
| addProductItem() | 添加产品项 | 603-672 |
| applyLastCount() | 应用上次清点 | 773-810 |

**交互流程**:
```javascript
// 1. 选择批次
async function onBatchChange() {
    state.currentBatchId = this.value;
    await loadBatchDetail(state.currentBatchId);
    showBatchStats();
}

// 2. 选择操作类型
function selectOperation(operation) {
    state.currentOperation = operation;
    showOperationSection(operation);
    document.getElementById('tracking-input').focus();
}

// 3. 输入快递单号（防抖0.5秒）
function onTrackingInput() {
    clearTimeout(state.searchTimeout);
    state.searchTimeout = setTimeout(() => {
        performSearch();
    }, 500);
}

// 4. 提交操作
async function submitOperation() {
    const data = collectFormData();
    const response = await fetch('/express/?action=save_record_api', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    const result = await response.json();
    if (result.success) {
        clearForm();
        refreshHistory();
        updateBatchStats();
    }
}
```

**移动端优化**:
```css
/* 大按钮设计 */
.operation-button {
    min-height: 60px;
    font-size: 18px;
    touch-action: manipulation;
}

/* 输入框优化 */
input[type="text"] {
    min-height: 44px;  /* iOS推荐最小44px */
    font-size: 16px;    /* 防止iOS自动缩放 */
}

/* 响应式布局 */
@media (max-width: 768px) {
    .grid-layout {
        grid-template-columns: 1fr;
    }
}
```

### 6.2 后台管理页面

**文件**: `dc_html/express/exp/js/modal.js`

**现代化模态框组件**:
```javascript
class Modal {
    // Promise风格的Alert
    async alert(message, title = '提示', type = 'info') {
        return new Promise((resolve) => {
            this.show({
                title, message, type,
                buttons: [{text: '确定', primary: true, callback: resolve}]
            });
        });
    }

    // Promise风格的Confirm
    async confirm(message, title = '确认', options = {}) {
        return new Promise((resolve) => {
            this.show({
                title, message,
                type: options.type || 'warning',
                buttons: [
                    {text: '取消', callback: () => resolve(false)},
                    {text: '确定', primary: true, callback: () => resolve(true)}
                ]
            });
        });
    }

    // Promise风格的Prompt
    async prompt(message, title = '输入', defaultValue = '') {
        return new Promise((resolve) => {
            this.show({
                title, message,
                type: 'input',
                defaultValue,
                buttons: [
                    {text: '取消', callback: () => resolve(null)},
                    {text: '确定', primary: true, callback: (value) => resolve(value)}
                ]
            });
        });
    }

    // HTML自动转义防XSS
    _escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// 全局实例
const modal = new Modal();

// 使用示例
const confirmed = await modal.confirm('确认删除该批次吗？', '警告');
if (confirmed) {
    // 执行删除
}
```

---

## 7. 安全设计

### 7.1 SQL注入防护

**全面使用PDO预处理语句**:
```php
// ✅ 正确（所有查询均采用）
$stmt = $pdo->prepare("SELECT * FROM express_package WHERE package_id = ?");
$stmt->execute([$package_id]);

// ❌ 禁止（系统中无此类代码）
$sql = "SELECT * FROM express_package WHERE package_id = {$_GET['id']}";
```

### 7.2 XSS防护

**输出转义**:
```php
// PHP模板
<?= htmlspecialchars($data, ENT_QUOTES, 'UTF-8') ?>

// JavaScript
const message = <?= json_encode($data, JSON_HEX_TAG | JSON_HEX_AMP) ?>;

// Modal.js自动转义
modal.alert(userInput);  // 自动调用_escapeHtml()
```

### 7.3 CSRF防护

**会话Cookie安全配置**:
```php
session_set_cookie_params([
    'samesite' => 'Strict',  // 严格同站
    'httponly' => true,       // 防JS访问
    'secure' => true          // 仅HTTPS
]);
```

### 7.4 认证安全

**密码哈希**:
```php
// 存储
$hash = password_hash($password, PASSWORD_DEFAULT);

// 验证
password_verify($password, $hash);
```

**防暴力破解**:
```php
// 5次失败锁定5分钟
if ($_SESSION['login_attempts'] >= 5
    && time() - $_SESSION['last_attempt_time'] < 300) {
    express_json_response(false, null, '登录尝试次数过多');
    exit;
}
```

---

## 8. 技术栈

### 8.1 后端技术

| 技术 | 版本 | 用途 |
|------|------|------|
| PHP | 7.4+ | 后端开发语言 |
| MySQL | 8.4.6 | 数据库服务器 |
| PDO | - | 数据库访问层 |
| Session | - | 会话管理 |

### 8.2 前端技术

| 技术 | 用途 |
|------|------|
| HTML5 | 页面结构 |
| CSS3 | 样式设计（Grid、Flexbox） |
| JavaScript ES6+ | 前端交互（async/await、Promise） |
| Fetch API | AJAX请求 |

### 8.3 开发规范

**PHP代码规范**:
- 函数命名: `express_` 前缀 + 下划线命名法
- 常量命名: `EXPRESS_` 前缀 + 全大写

**JavaScript代码规范**:
- ES6+ 语法
- async/await 异步处理
- 驼峰命名法

---

## 9. 部署架构

### 9.1 目录权限

```bash
# 应用目录（只读）
chmod -R 755 /home/user/mrscodx/app/express
chmod -R 755 /home/user/mrscodx/dc_html/express

# 日志目录（可写）
chmod -R 775 /home/user/mrscodx/logs/express
chown -R www-data:www-data /home/user/mrscodx/logs/express

# 配置文件（只读，敏感）
chmod 600 /home/user/mrscodx/app/express/config_express/env_express.php
```

### 9.2 Nginx配置

```nginx
server {
    listen 443 ssl http2;
    server_name express.example.com;

    root /home/user/mrscodx/dc_html;

    # 前台
    location /express/ {
        try_files $uri $uri/ /express/index.php?$query_string;
    }

    # 后台
    location /express/exp/ {
        try_files $uri $uri/ /express/exp/index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        include fastcgi_params;
    }
}
```

---

## 10. 性能优化

### 10.1 数据库优化

**索引策略**:
```sql
-- 高频查询索引
CREATE INDEX idx_batch_id ON express_package(batch_id);
CREATE INDEX idx_package_status ON express_package(package_status);
CREATE INDEX idx_tracking_number ON express_package(tracking_number);
```

**连接池**:
```php
// 单例模式
function express_get_pdo() {
    static $pdo = null;
    if ($pdo === null) {
        $pdo = new PDO(..., [PDO::ATTR_PERSISTENT => true]);
    }
    return $pdo;
}
```

### 10.2 前端优化

**防抖搜索**:
```javascript
// 0.5秒防抖
clearTimeout(state.searchTimeout);
state.searchTimeout = setTimeout(() => performSearch(), 500);
```

**结果缓存**:
```javascript
// Map缓存搜索结果
if (state.searchResults.has(keyword)) {
    return state.searchResults.get(keyword);
}
```

---

**文档结束**

**版本历史**:
- v1.0 (2025-12-16): 初始版本发布，系统更名为"通用物品接收清点系统"
